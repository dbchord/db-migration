name: DB Migration

on:
  workflow_dispatch:
    inputs:
      start:
        description: "Enter the starting number"
        required: true
        default: "1"

jobs:
  db-migration:
    environment: cloudflare

    runs-on: ubuntu-latest

    steps:
      # Checkout the current repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Clone SQL repository
      - name: Clone SQL Repository
        run: git clone https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/dbchord/db-sql.git

      # Set up Node.js
      - name: Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"

      # Install dependencies
      - name: Install Dependencies
        run: npm ci

      # Run npm script
      - name: Run Script
        run: |
          start=${{ github.event.inputs.start }}
          counter=0
          max_retries=3
          retry_delay=3

          for file in ./db-sql/*; do
            if [[ -f "$file" && $counter -gt $start ]]; then
              attempt=0
              success=false

              while [[ $attempt -lt $max_retries ]]; do
                echo "[$((counter+1))] ($((attempt+1)) / $((max_retries))): $file"
                echo | npm start -- --file=$file

                # Check if the command was successful
                if [[ $? -eq 0 ]]; then
                  success=true
                  break
                else
                  echo "Error processing file: $file. Retrying in $retry_delay seconds..."
                  sleep $retry_delay
                fi

                attempt=$((attempt + 1))
              done

              if [[ $success == false ]]; then
                echo "Failed to process file after $max_retries attempts: $file"
                exit 1
              fi
            fi

            counter=$((counter + 1))
          done
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
